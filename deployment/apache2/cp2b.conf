<VirtualHost *:80>
    ServerName your-domain.com
    ServerAlias www.your-domain.com

    # Admin contact
    ServerAdmin admin@your-domain.com

    # Document root for React frontend
    DocumentRoot /var/www/cp2b/frontend/dist

    # Frontend directory configuration
    <Directory /var/www/cp2b/frontend/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        # Enable SPA routing - redirect all requests to index.html
        # EXCEPT for API calls and uploaded files
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} !^/api/
        RewriteCond %{REQUEST_URI} !^/uploads/
        RewriteRule . /index.html [L]
    </Directory>

    # Reverse proxy for backend API
    ProxyPreserveHost On
    ProxyPass /api http://localhost:3001/api
    ProxyPassReverse /api http://localhost:3001/api

    # Reverse proxy for uploaded files
    ProxyPass /uploads http://localhost:3001/uploads
    ProxyPassReverse /uploads http://localhost:3001/uploads

    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Cache control for static assets
    <FilesMatch "\.(ico|jpg|jpeg|png|gif|svg|webp|woff|woff2|ttf|eot|css|js)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # Don't cache HTML files
    <FilesMatch "\.(html)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>

    # Enable gzip compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
        AddOutputFilterByType DEFLATE application/javascript application/json
        AddOutputFilterByType DEFLATE application/xml application/xhtml+xml
        AddOutputFilterByType DEFLATE image/svg+xml
    </IfModule>

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/cp2b-error.log
    CustomLog ${APACHE_LOG_DIR}/cp2b-access.log combined

    # Optional: Set log level (error, warn, info, debug)
    LogLevel warn
</VirtualHost>

# SSL/HTTPS Configuration (uncomment after obtaining SSL certificate)
#<VirtualHost *:443>
#    ServerName your-domain.com
#    ServerAlias www.your-domain.com
#
#    ServerAdmin admin@your-domain.com
#    DocumentRoot /var/www/cp2b/frontend/dist
#
#    # SSL Configuration
#    SSLEngine on
#    SSLCertificateFile /etc/letsencrypt/live/your-domain.com/fullchain.pem
#    SSLCertificateKeyFile /etc/letsencrypt/live/your-domain.com/privkey.pem
#
#    # Modern SSL configuration
#    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
#    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
#    SSLHonorCipherOrder off
#    SSLSessionTickets off
#
#    # HSTS (uncomment after testing HTTPS)
#    #Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
#
#    # Frontend directory configuration
#    <Directory /var/www/cp2b/frontend/dist>
#        Options -Indexes +FollowSymLinks
#        AllowOverride None
#        Require all granted
#
#        RewriteEngine On
#        RewriteBase /
#        RewriteRule ^index\.html$ - [L]
#        RewriteCond %{REQUEST_FILENAME} !-f
#        RewriteCond %{REQUEST_FILENAME} !-d
#        RewriteCond %{REQUEST_URI} !^/api/
#        RewriteCond %{REQUEST_URI} !^/uploads/
#        RewriteRule . /index.html [L]
#    </Directory>
#
#    # Reverse proxy for backend API
#    ProxyPreserveHost On
#    ProxyPass /api http://localhost:3001/api
#    ProxyPassReverse /api http://localhost:3001/api
#
#    # Reverse proxy for uploaded files
#    ProxyPass /uploads http://localhost:3001/uploads
#    ProxyPassReverse /uploads http://localhost:3001/uploads
#
#    # Security headers
#    Header always set X-Content-Type-Options "nosniff"
#    Header always set X-Frame-Options "SAMEORIGIN"
#    Header always set X-XSS-Protection "1; mode=block"
#    Header always set Referrer-Policy "strict-origin-when-cross-origin"
#    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'"
#
#    # Cache control for static assets
#    <FilesMatch "\.(ico|jpg|jpeg|png|gif|svg|webp|woff|woff2|ttf|eot|css|js)$">
#        Header set Cache-Control "public, max-age=31536000, immutable"
#    </FilesMatch>
#
#    # Don't cache HTML files
#    <FilesMatch "\.(html)$">
#        Header set Cache-Control "no-cache, no-store, must-revalidate"
#        Header set Pragma "no-cache"
#        Header set Expires "0"
#    </FilesMatch>
#
#    # Enable gzip compression
#    <IfModule mod_deflate.c>
#        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
#        AddOutputFilterByType DEFLATE application/javascript application/json
#        AddOutputFilterByType DEFLATE application/xml application/xhtml+xml
#        AddOutputFilterByType DEFLATE image/svg+xml
#    </IfModule>
#
#    # Logs
#    ErrorLog ${APACHE_LOG_DIR}/cp2b-ssl-error.log
#    CustomLog ${APACHE_LOG_DIR}/cp2b-ssl-access.log combined
#    LogLevel warn
#</VirtualHost>

# Redirect HTTP to HTTPS (uncomment after SSL is configured)
#<VirtualHost *:80>
#    ServerName your-domain.com
#    ServerAlias www.your-domain.com
#    Redirect permanent / https://your-domain.com/
#</VirtualHost>
